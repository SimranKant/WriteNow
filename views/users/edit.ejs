<% layout('layouts/boilerplate') -%>

<div class="container mt-5">
  <h2>Edit Profile</h2>
  <form
    action="/users/<%= user._id %>?_method=PUT"
    method="POST"
    enctype="multipart/form-data"
    id="editProfileForm"
  >
    <div class="mb-3">
      <label class="form-label">Username</label>
      <input
        type="text"
        name="username"
        id="usernameField"
        class="form-control"
        value="<%= user.username %>"
        required
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Email</label>
      <input
        type="email"
        name="email"
        id="emailField"
        class="form-control"
        value="<%= user.email %>"
        required
      />
    </div>

    <!-- Confirm Password (hidden by default) -->
    <div class="mb-3" id="passwordField" style="display: none;">
      <label class="form-label">Confirm Password</label>
      <input
        type="password"
        name="password"
        class="form-control"
        placeholder="Enter your password"
      />
      <small class="text-muted">Required if changing username or email</small>
    </div>

    <div class="mb-3">
      <label class="form-label">Age</label>
      <input
        type="number"
        name="age"
        class="form-control"
        value="<%= user.age %>"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Bio</label>
      <textarea name="bio" class="form-control" rows="3"><%= user.bio %></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Profile Picture</label><br />
      <img
        src="<%= user.profilePicture?.url || '/images/default-avatar.png' %>"
        alt="Profile"
        class="rounded-circle mb-3"
        style="width: 100px; height: 100px; object-fit: cover"
      />
      <input type="file" name="profilePicture" class="form-control" />
    </div>

    <button type="submit" class="btn btn-success">Save Changes</button>
    <a href="/users/<%= user._id %>" class="btn btn-secondary">Cancel</a>
  </form>
</div>

<script>
  const usernameField = document.getElementById("usernameField");
  const emailField = document.getElementById("emailField");
  const passwordField = document.getElementById("passwordField");

  const originalUsername = "<%= user.username %>";
  const originalEmail = "<%= user.email %>";

  function checkChanges() {
    if (
      usernameField.value !== originalUsername ||
      emailField.value !== originalEmail
    ) {
      passwordField.style.display = "block";
    } else {
      passwordField.style.display = "none";
    }
  }

  usernameField.addEventListener("input", checkChanges);
  emailField.addEventListener("input", checkChanges);
</script>
